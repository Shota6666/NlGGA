<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç–Šé´¨å­ï¼šè¶…ç©©ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%);
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .ui-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        .hidden {
            display: none !important;
            pointer-events: none;
        }

        h1 {
            color: #FFD700;
            font-size: 3rem;
            text-shadow: 0 4px 0 #d35400;
            margin-bottom: 20px;
            font-weight: 900;
        }

        button {
            background: #FF9800;
            border: 4px solid #fff;
            padding: 15px 50px;
            color: white;
            font-size: 1.8rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #E65100;
            transition: all 0.1s;
            margin: 10px;
            font-weight: bold;
            font-family: inherit;
        }

        button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #E65100;
        }

        button.secondary {
            background: #4CAF50;
            box-shadow: 0 6px 0 #2E7D32;
            font-size: 1.2rem;
            padding: 10px 30px;
        }
        
        button.secondary:active {
            box-shadow: 0 2px 0 #2E7D32;
        }

        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            z-index: 5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .badge {
            background: #fff;
            padding: 8px 20px;
            border-radius: 30px;
            border: 3px solid #333;
            font-weight: 800;
            font-size: 1.2rem;
            color: #333;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.2);
        }

        #tutorial-text {
            position: absolute;
            top: 25%;
            width: 100%;
            text-align: center;
            color: #333;
            font-weight: bold;
            font-size: 1.4rem;
            pointer-events: none;
            text-shadow: 2px 2px 0 #fff;
            animation: pulse 1.5s infinite;
        }

        #fail-reason {
            color: #FF5252;
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: bold;
        }

        /* è®“é´¨å­çœ‹èµ·ä¾†æ›´å¯æ„›çš„å¾®èª¿ */
        canvas {
            filter: contrast(1.1);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="hud" class="hidden">
        <div class="badge">é«˜åº¦: <span id="score-display">0</span> å±¤</div>
    </div>

    <div id="tutorial-text" class="hidden">
        å·¦å³ç§»å‹•ç„æº–<br>æ”¾é–‹æ‰‹æŒ‡ä¸Ÿä¸‹
    </div>

    <div id="start-screen" class="ui-screen">
        <h1>è¶…ç´šç–Šé´¨å­</h1>
        <div style="font-size: 60px; margin-bottom: 30px; animation: bounce 1s infinite;">ğŸ¥</div>
        <button onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
        <p style="color:white; margin-top:10px; font-size: 0.9rem;">(å·²é–‹å•Ÿé˜²æ»¾å‹•è¼”åŠ©æ¨¡å¼)</p>
    </div>

    <div id="game-over-screen" class="ui-screen hidden">
        <h2 style="color: white; font-size: 2.5rem; margin: 0;">å“å‘€!</h2>
        <p id="fail-reason">é´¨å­æ‰ä¸‹å»äº†</p>
        
        <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 20px; margin: 20px 0; text-align: center; border: 4px solid #333;">
            <div style="font-size: 1.2rem; color: #666;">æœ€é«˜ç´€éŒ„</div>
            <div style="font-size: 4rem; color: #333; font-weight: 900; line-height: 1;"><span id="final-score">0</span></div>
            <div style="font-size: 1rem; color: #666;">å±¤</div>
        </div>

        <button onclick="restartGame()">å†è©¦ä¸€æ¬¡</button>
        <button class="secondary" onclick="goHome()">å›é¦–é </button>
    </div>
</div>

<script>
    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Events = Matter.Events;

    let engine, render, runner;
    let gameActive = false;
    let score = 0;
    let isDropping = false;
    let inputX = window.innerWidth / 2;
    
    // éŠæˆ²åƒæ•¸
    const GAME_CONFIG = {
        platformWidth: 260,  // å¹³å°åŠ å¯¬ä¸€é»é»
        duckSize: 30,        // é´¨å­åŠå¾‘
    };

    // é´¨å­åƒæ•¸è¨­å®š (å…¨é¢ç§»é™¤å½ˆåŠ›ï¼Œæ¥µå¤§åŒ–ç©©å®šæ€§)
    const DUCK_TYPES = [
        { color: '#8BC34A', friction: 1.0, restitution: 0.0, density: 0.005 }, // ç¶ 
        { color: '#FFEB3B', friction: 1.0, restitution: 0.0, density: 0.005 }, // é»ƒ
        { color: '#29B6F6', friction: 0.9, restitution: 0.1, density: 0.005 }, // è— (ç¨å¾®æ»‘ä¸€é»é»é»)
        { color: '#FF5722', friction: 1.0, restitution: 0.2, density: 0.005 }  // ç´…
    ];

    function init() {
        engine = Engine.create();
        
        // å¢åŠ ç‰©ç†é‹ç®—ç²¾åº¦ï¼Œé˜²æ­¢ç©¿é€å’ŒæŠ–å‹•
        engine.positionIterations = 20; // åŸæœ¬æ˜¯ 6
        engine.velocityIterations = 20; // åŸæœ¬æ˜¯ 4

        const container = document.getElementById('game-container');
        
        render = Render.create({
            element: container,
            engine: engine,
            options: {
                width: window.innerWidth,
                height: window.innerHeight,
                wireframes: false, // è¨­ç‚º true å¯ä»¥çœ‹åˆ°å…«è§’å½¢çš„ç§˜å¯†ï¼Œä½†æˆ‘å€‘ä¿æŒ false
                background: 'transparent'
            }
        });

        // ç¢°æ’æª¢æ¸¬ (è¼¸è´åˆ¤å®š)
        Events.on(engine, 'collisionStart', function(event) {
            if (!gameActive) return;
            const pairs = event.pairs;
            
            for (let i = 0; i < pairs.length; i++) {
                const bodyA = pairs[i].bodyA;
                const bodyB = pairs[i].bodyB;

                // ç¢°åˆ°æ­»äº¡åœ°æ¿
                if ((bodyA.label === 'duck' && bodyB.label === 'floor') || 
                    (bodyB.label === 'duck' && bodyA.label === 'floor')) {
                    
                    // åªæœ‰ç•¶é€™éš»é´¨å­çœŸçš„æ‰ä¸‹å»æ™‚æ‰çµæŸï¼Œè€Œä¸æ˜¯å‰›ç”Ÿæˆçš„ç¬é–“èª¤åˆ¤
                    const duckBody = bodyA.label === 'duck' ? bodyA : bodyB;
                    if(duckBody.position.y > window.innerHeight - 150) { 
                        endGame("é´¨å­æ‰ä¸‹å»äº†ï¼");
                    }
                }
            }
        });

        // æª¢æŸ¥åˆ†æ•¸
        Events.on(engine, 'afterUpdate', function() {
            if (!gameActive) return;
            const bodies = Composite.allBodies(engine.world);
            // åªè¦é«˜åº¦é«˜æ–¼åœ°æ¿ä¸€å®šè·é›¢å°±ç®—å­˜æ´»
            let safeDucks = bodies.filter(b => b.label === 'duck' && b.position.y < window.innerHeight - 50);
            score = safeDucks.length;
            document.getElementById('score-display').innerText = score;
        });
        
        Render.run(render);
        runner = Runner.create();
        Runner.run(runner, engine);

        // è‡ªå®šç¾©ç¹ªåœ–
        Events.on(render, 'afterRender', function() {
            const ctx = render.context;
            
            // ç„æº–ç·š
            if (gameActive && !isDropping) {
                ctx.beginPath();
                ctx.moveTo(inputX, 50);
                ctx.lineTo(inputX, window.innerHeight - 100);
                ctx.strokeStyle = "rgba(255, 255, 255, 0.4)";
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 10]);
                ctx.stroke();
                ctx.setLineDash([]);

                // é è¦½
                ctx.globalAlpha = 0.5;
                ctx.fillStyle = DUCK_TYPES[Math.min(Math.floor(score/3), 3)].color;
                ctx.beginPath();
                ctx.arc(inputX, 80, GAME_CONFIG.duckSize, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }

            // ç•«é´¨å­ (è¦–è¦ºä¸Šç•«æˆåœ“çš„ï¼Œæ©è“‹å®ƒæ˜¯å…«è§’å½¢çš„äº‹å¯¦)
            Composite.allBodies(engine.world).forEach(body => {
                if (body.label === 'duck') {
                    drawDuckFace(ctx, body);
                }
            });
        });

        window.addEventListener('resize', () => {
            render.canvas.width = window.innerWidth;
            render.canvas.height = window.innerHeight;
        });
    }

    function drawDuckFace(ctx, body) {
        const pos = body.position;
        const angle = body.angle;
        // é›–ç„¶ç‰©ç†æ˜¯å¤šé‚Šå½¢ï¼Œæˆ‘å€‘ç”¨å¤–æ¥åœ“åŠå¾‘ä¾†ç•«ï¼Œè®“å®ƒçœ‹èµ·ä¾†æ˜¯åœ“çš„
        const r = GAME_CONFIG.duckSize; 
        
        ctx.translate(pos.x, pos.y);
        ctx.rotate(angle);
        
        // èº«é«” (åœ“å½¢) - è¦†è“‹åœ¨å…«è§’å½¢ç‰©ç†æ¨¡å‹ä¸Š
        ctx.fillStyle = body.render.fillStyle;
        ctx.beginPath();
        ctx.arc(0, 0, r, 0, Math.PI*2);
        ctx.fill();

        // çœ¼ç›
        ctx.fillStyle = '#000';
        ctx.beginPath();
        ctx.arc(-r*0.3, -r*0.15, 3.5, 0, Math.PI*2);
        ctx.arc(r*0.3, -r*0.15, 3.5, 0, Math.PI*2);
        ctx.fill();
        
        // å˜´å·´
        ctx.fillStyle = '#FF9800';
        ctx.beginPath();
        ctx.ellipse(0, r*0.15, 7, 5, 0, 0, Math.PI*2);
        ctx.fill();

        // è…®ç´… (å¢åŠ å¯æ„›åº¦)
        ctx.fillStyle = 'rgba(255,0,0,0.2)';
        ctx.beginPath();
        ctx.arc(-r*0.5, 0, 5, 0, Math.PI*2);
        ctx.arc(r*0.5, 0, 5, 0, Math.PI*2);
        ctx.fill();

        ctx.rotate(-angle);
        ctx.translate(-pos.x, -pos.y);
    }

    function createWorld() {
        Composite.clear(engine.world);
        Engine.clear(engine);

        const width = window.innerWidth;
        const height = window.innerHeight;

        // 1. å¹³å° (å¯¬åº¦å¢åŠ ï¼Œä¸”æ‘©æ“¦åŠ›æ¥µå¤§)
        const platform = Bodies.rectangle(width/2, height - 100, GAME_CONFIG.platformWidth, 40, { 
            isStatic: true,
            label: 'platform',
            render: { fillStyle: '#689F38', strokeStyle: '#33691E', lineWidth: 4 },
            chamfer: { radius: 5 },
            friction: 1.0 // åœ°æ¿ä¹Ÿå¾ˆé»
        });

        // 2. æ­»äº¡åˆ¤å®šå€ (çœ‹ä¸è¦‹çš„åœ°æ¿)
        const floor = Bodies.rectangle(width/2, height + 50, width * 2, 100, {
            isStatic: true,
            label: 'floor',
            isSensor: true,
            render: { visible: false }
        });

        Composite.add(engine.world, [platform, floor]);
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('tutorial-text').classList.remove('hidden');
        
        gameActive = true;
        isDropping = false;
        score = 0;
        
        createWorld();

        setTimeout(() => {
            document.getElementById('tutorial-text').classList.add('hidden');
        }, 2000);
    }

    function spawnDuck() {
        if (!gameActive || isDropping) return;

        isDropping = true;
        
        let typeIndex = Math.min(Math.floor(score / 3), DUCK_TYPES.length - 1);
        if (score > 15) typeIndex = Math.floor(Math.random() * DUCK_TYPES.length);
        const duckData = DUCK_TYPES[typeIndex];

        // --- æ ¸å¿ƒé­”æ³•ï¼šä½¿ç”¨å…«è§’å½¢ (Polygon 8) å–ä»£åœ“å½¢ (Circle) ---
        // 8é‚Šå½¢çœ‹èµ·ä¾†å¾ˆåœ“ï¼Œä½†æœ‰8å€‹å¹³é¢å¯ä»¥ç«™ç«‹ï¼Œé€™æ˜¯é˜²æ»¾å‹•çš„é—œéµ
        const duck = Bodies.polygon(inputX, 80, 8, GAME_CONFIG.duckSize, {
            label: 'duck',
            restitution: duckData.restitution,      // å½ˆåŠ›æ¥µä½
            friction: duckData.friction,            // æ‘©æ“¦åŠ›æ¥µé«˜
            frictionStatic: 10.0,                   // éœæ‘©æ“¦åŠ›è¶…é«˜ (è®“å®ƒé»ä½)
            density: duckData.density,              // åŠ é‡
            chamfer: { radius: 8 },                 // åœ“è§’ï¼šè®“å…«è§’å½¢ä¸è¦å¤ªå°–éŠ³ï¼Œæ‰‹æ„Ÿæ›´å¥½
            render: { fillStyle: duckData.color }
        });

        // çµ¦ä¸€é»éš¨æ©Ÿæ—‹è½‰ï¼Œé¿å…å…¨éƒ¨éƒ½æ­£æ­£çš„è½ä¸‹å¤ªç„¡èŠ
        // Matter.Body.setAngle(duck, Math.random() * 0.1 - 0.05);

        Composite.add(engine.world, duck);

        // å†·å»æ™‚é–“
        setTimeout(() => { isDropping = false; }, 500);
    }

    function endGame(reason) {
        if (!gameActive) return;
        gameActive = false;
        
        document.getElementById('fail-reason').innerText = reason;
        document.getElementById('final-score').innerText = score;
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('hud').classList.add('hidden');
    }

    function restartGame() {
        startGame();
    }

    function goHome() {
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
        Composite.clear(engine.world);
    }

    // --- è¼¸å…¥æ§åˆ¶ ---
    function updateInput(x) {
        inputX = Math.max(GAME_CONFIG.duckSize, Math.min(window.innerWidth - GAME_CONFIG.duckSize, x));
    }

    document.addEventListener('mousemove', e => { if(gameActive) updateInput(e.clientX); });
    document.addEventListener('touchmove', e => {
        if(gameActive && e.touches.length > 0) {
            e.preventDefault();
            updateInput(e.touches[0].clientX);
        }
    }, { passive: false });

    document.addEventListener('mouseup', spawnDuck);
    document.addEventListener('touchend', spawnDuck);

    window.onload = init;

</script>
</body>
</html>
